# -*- coding: utf-8 -*-
"""final_wallpaper.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1CoIsDd4s_nCqQyEdE1QCbSLVeX3Xoz1T
"""

import streamlit as st
from openai import OpenAI
from PIL import Image, ImageDraw
import io
import base64
import numpy as np
import matplotlib.pyplot as plt
from collections import Counter
import colorsys


# =========================
# OpenAI Client
# =========================

def get_client(api_key: str) -> OpenAI:
    return OpenAI(api_key=api_key)


# =========================
# ì´ë¯¸ì§€/íŒ”ë ˆíŠ¸ ìœ í‹¸
# =========================

def image_to_base64(image: Image.Image) -> str:
    """PIL ì´ë¯¸ì§€ë¥¼ base64 ë¬¸ìì—´ë¡œ ë³€í™˜"""
    buffered = io.BytesIO()
    image.save(buffered, format="PNG")
    img_bytes = buffered.getvalue()
    return base64.b64encode(img_bytes).decode("utf-8")


def extract_palette_from_images(images, num_colors: int = 5):
    """ì—¬ëŸ¬ ì¥ì˜ ì´ë¯¸ì§€ì—ì„œ ê³µí†µ íŒ”ë ˆíŠ¸ ì¶”ì¶œ (ê°„ë‹¨ ë²„ì „)"""
    all_pixels = []

    for image in images:
        img = image.convert("RGB")
        img = img.resize((130, 130))  # ê³„ì‚°ëŸ‰ ì¤„ì´ê¸°
        arr = np.array(img)
        pixels = arr.reshape(-1, 3)
        all_pixels.extend(map(tuple, pixels))

    if not all_pixels:
        return np.array([])

    counts = Counter(all_pixels)
    most_common = counts.most_common(num_colors)
    colors = np.array([c[0] for c in most_common]) / 255.0  # 0~1 ë²”ìœ„
    return colors


def plot_palette(colors):
    """ìƒ‰ìƒ íŒ”ë ˆíŠ¸ë¥¼ matplotlibìœ¼ë¡œ ì‹œê°í™”"""
    if colors.size == 0:
        return None

    num_colors = len(colors)
    fig, ax = plt.subplots(figsize=(num_colors * 1.2, 1.5))
    ax.set_xlim(0, num_colors)
    ax.set_ylim(0, 1)
    ax.axis("off")

    for i, rgb in enumerate(colors):
        ax.add_patch(plt.Rectangle((i, 0), 1, 1, color=rgb))

    return fig


def colors_to_hex_list(colors):
    """íŒ”ë ˆíŠ¸ ìƒ‰ë“¤ì„ #RRGGBB ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜ (í”„ë¡¬í”„íŠ¸ìš©)"""
    hex_list = []
    for rgb in colors:
        r, g, b = (rgb * 255).astype(int)
        hex_list.append(f"#{r:02X}{g:02X}{b:02X}")
    return hex_list


# =========================
# ì»¬ëŸ¬ ì¡°ì • (ë¬´ë“œ íŒŒë¼ë¯¸í„° ë°˜ì˜)
# =========================

def adjust_colors_with_mood(colors, brightness_level, saturation_level):
    """
    0~1 brightness / saturation ìŠ¬ë¼ì´ë” ê°’ì„ ì´ìš©í•´
    íŒ”ë ˆíŠ¸ ìƒ‰ì„ ì „ì²´ì ìœ¼ë¡œ ì¡°ì • (ê°„ë‹¨í•œ HLS ì¡°ì •)
    """
    if colors.size == 0:
        return colors

    adjusted = []
    for rgb in colors:
        r, g, b = rgb
        h, l, s = colorsys.rgb_to_hls(r, g, b)

        # ë°ê¸° ì¡°ì •
        l = (l * 0.5) + (brightness_level * 0.5)
        # ì±„ë„ ì¡°ì •
        s = (s * 0.4) + (saturation_level * 0.6)

        r2, g2, b2 = colorsys.hls_to_rgb(h, l, s)
        adjusted.append([r2, g2, b2])

    return np.clip(np.array(adjusted), 0.0, 1.0)


# =========================
# íŒ¨í„´ & ë‹¨ìƒ‰ ìƒì„±
# =========================

def generate_solid_wallpaper(colors, size=(1024, 1792)):
    """íŒ”ë ˆíŠ¸ì˜ ëŒ€í‘œ ìƒ‰ìœ¼ë¡œ ë‹¨ìƒ‰ ë°°ê²½í™”ë©´ ìƒì„±"""
    width, height = size
    img = Image.new("RGB", size)

    if colors.size == 0:
        color = (240, 240, 240)
    else:
        # ì²« ë²ˆì§¸ ìƒ‰ì„ ëŒ€í‘œ ìƒ‰ìœ¼ë¡œ ì‚¬ìš© (ë˜ëŠ” í‰ê·  ì¨ë„ ë¨)
        rgb = colors[0]
        color = tuple((rgb * 255).astype(int))

    draw = ImageDraw.Draw(img)
    draw.rectangle([0, 0, width, height], fill=color)
    return img


def generate_stripe_pattern(colors, size=(1024, 1792)):
    """íŒ”ë ˆíŠ¸ ìƒ‰ìœ¼ë¡œ ìŠ¤íŠ¸ë¼ì´í”„ íŒ¨í„´ ìƒì„±"""
    if colors.size == 0:
        colors = np.array([[0.9, 0.9, 0.9]])

    width, height = size
    img = Image.new("RGB", size)
    draw = ImageDraw.Draw(img)

    num_stripes = len(colors)
    stripe_width = int(width / num_stripes) if num_stripes > 0 else width

    for i, rgb in enumerate(colors):
        x0 = i * stripe_width
        x1 = (i + 1) * stripe_width if i < num_stripes - 1 else width
        color = tuple((rgb * 255).astype(int))
        draw.rectangle([x0, 0, x1, height], fill=color)

    return img


def generate_check_pattern(colors, size=(1024, 1792)):
    """íŒ”ë ˆíŠ¸ ìƒ‰ìœ¼ë¡œ ì²´í¬(ê²©ì) íŒ¨í„´ ìƒì„±"""
    if colors.size == 0:
        colors = np.array([[0.9, 0.9, 0.9], [0.7, 0.7, 0.7]])

    width, height = size
    img = Image.new("RGB", size)
    draw = ImageDraw.Draw(img)

    num_colors = len(colors)
    num_rows = 10
    num_cols = 6

    cell_w = int(width / num_cols)
    cell_h = int(height / num_rows)

    for row in range(num_rows):
        for col in range(num_cols):
            idx = (row + col) % num_colors
            rgb = colors[idx]
            color = tuple((rgb * 255).astype(int))
            x0 = col * cell_w
            y0 = row * cell_h
            x1 = (col + 1) * cell_w
            y1 = (row + 1) * cell_h
            draw.rectangle([x0, y0, x1, y1], fill=color)

    return img


def generate_dot_pattern(colors, size=(1024, 1792)):
    """íŒ”ë ˆíŠ¸ ìƒ‰ìœ¼ë¡œ ë„íŠ¸ íŒ¨í„´ ìƒì„±"""
    if colors.size == 0:
        colors = np.array([[0.95, 0.95, 0.95], [0.2, 0.2, 0.2]])

    width, height = size
    img = Image.new("RGB", size)
    draw = ImageDraw.Draw(img)

    bg_color = tuple((colors[0] * 255).astype(int))
    draw.rectangle([0, 0, width, height], fill=bg_color)

    dot_colors = colors[1:] if len(colors) > 1 else colors
    num_rows = 12
    num_cols = 7
    radius = int(min(width / (num_cols * 3), height / (num_rows * 3)))

    for row in range(num_rows):
        for col in range(num_cols):
            idx = (row * num_cols + col) % len(dot_colors)
            rgb = dot_colors[idx]
            color = tuple((rgb * 255).astype(int))
            cx = int((col + 0.5) * width / num_cols)
            cy = int((row + 0.5) * height / num_rows)
            draw.ellipse(
                [cx - radius, cy - radius, cx + radius, cy + radius],
                fill=color,
            )

    return img


# =========================
# ë¬´ë“œ íŒŒë¼ë¯¸í„° â†’ í…ìŠ¤íŠ¸ ì„¤ëª…
# =========================

def describe_mood_params(brightness, saturation, abstractness):
    def level_desc(x):
        if x < 0.33:
            return "low"
        elif x < 0.66:
            return "medium"
        else:
            return "high"

    return (
        f"Brightness: {level_desc(brightness)}, "
        f"Saturation: {level_desc(saturation)}, "
        f"Abstractness: {level_desc(abstractness)}."
    )


def abstractness_phrase(abstractness):
    if abstractness < 0.33:
        return "slightly abstract, closer to realistic composition"
    elif abstractness < 0.66:
        return "moderately abstract with some recognizable structure"
    else:
        return "highly abstract, focusing on shapes and colors rather than objects"


# =========================
# Streamlit UI ì„¤ì •
# =========================

st.set_page_config(
    page_title="AI Mood Wallpaper Generator",
    page_icon="ğŸ¨",
    layout="wide",
)

st.title("ğŸ¨ Moodboard ê¸°ë°˜ AI ì›”í˜ì´í¼ ìƒì„±ê¸°")
st.write(
    """
ì—¬ëŸ¬ ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´,
ê³µí†µëœ **ë¬´ë“œ & ì»¬ëŸ¬ íŒ”ë ˆíŠ¸**ë¥¼ ë¶„ì„í•´ì„œ
ì„ íƒí•œ ë°©ì‹ìœ¼ë¡œ **ë°°ê²½í™”ë©´(ë‹¨ìƒ‰ / ë¹„ìŠ·í•œ ë¬´ë“œ ì´ë¯¸ì§€ / ì¶”ìƒ / stripe / check / dot)**ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
"""
)

# --- ì‚¬ì´ë“œë°”: ì„¤ì • ---
st.sidebar.header("ì„¤ì •")

api_key = st.sidebar.text_input("OpenAI API Key ì…ë ¥ (ë¬´ë“œ/ì´ë¯¸ì§€ ë¶„ì„ìš©)", type="password")

style_option = st.sidebar.selectbox(
    "ì „ì²´ ìŠ¤íƒ€ì¼ í‚¤ì›Œë“œ",
    [
        "Abstract pattern",
        "Soft gradient",
        "Textile / fabric-like pattern",
        "Minimal geometric",
        "Y2K / cute pastel",
    ],
)

generation_mode = st.sidebar.selectbox(
    "ë°°ê²½í™”ë©´ íƒ€ì… ì„ íƒ",
    [
        "ë‹¨ìƒ‰ (Solid color)",
        "ë¹„ìŠ·í•œ ë¬´ë“œì˜ ì´ë¯¸ì§€ (AI)",
        "ì¶”ìƒ ë°°ê²½í™”ë©´ (AI)",
        "Stripe íŒ¨í„´",
        "Check íŒ¨í„´",
        "Dot íŒ¨í„´",
    ],
)

extra_prompt = st.sidebar.text_input(
    "ì¶”ê°€ ìŠ¤íƒ€ì¼ í…ìŠ¤íŠ¸ ì˜µì…˜ (ì„ íƒ)",
    value="",
    help="ì˜ˆ: pastel, minimal, cozy, dark, futuristic, dreamy ...",
)

num_palette_colors = st.sidebar.slider("íŒ”ë ˆíŠ¸ ìƒ‰ìƒ ê°œìˆ˜", 3, 8, 5)

st.sidebar.markdown("---")
st.sidebar.subheader("ë¬´ë“œ íŒŒë¼ë¯¸í„°")
brightness_level = st.sidebar.slider("Brightness (ë°ê¸°)", 0.0, 1.0, 0.6, 0.05)
saturation_level = st.sidebar.slider("Saturation (ì±„ë„)", 0.0, 1.0, 0.7, 0.05)
abstract_level = st.sidebar.slider("Abstractness (ì¶”ìƒ ì •ë„)", 0.0, 1.0, 0.7, 0.05)

st.sidebar.markdown("---")
st.sidebar.write("1. ì´ë¯¸ì§€ ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œ â†’ 2. Generate ë²„íŠ¼ í´ë¦­")


# --- ë©”ì¸ ì˜ì—­: ì´ë¯¸ì§€ ì—…ë¡œë“œ ---
uploaded_files = st.file_uploader(
    "ë¬´ë“œë¥¼ ë§Œë“¤ ì—¬ëŸ¬ ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (ë£©ë¶, OOTD, ë ˆí¼ëŸ°ìŠ¤ ë“±)",
    type=["png", "jpg", "jpeg"],
    accept_multiple_files=True,
)

generate_button = st.button("âœ¨ ë°°ê²½í™”ë©´ ìƒì„±í•˜ê¸°")


# =========================
# ë©”ì¸ ë¡œì§
# =========================

if generate_button:
    if not uploaded_files:
        st.error("ì´ë¯¸ì§€ë¥¼ ìµœì†Œ 1ì¥ ì´ìƒ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.")
    else:
        # OpenAI í´ë¼ì´ì–¸íŠ¸ (ìˆìœ¼ë©´ ìƒì„±)
        client = get_client(api_key) if api_key else None

        # PIL ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸
        pil_images = [Image.open(f).convert("RGB") for f in uploaded_files]

        col_left, col_right = st.columns(2)

        # --------------------
        # ì™¼ìª½: ì›ë³¸ ì´ë¯¸ì§€ë“¤ + íŒ”ë ˆíŠ¸
        # --------------------
        with col_left:
            st.subheader("â‘  ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë“¤ (Moodboard)")
            for img in pil_images:
                st.image(img, use_column_width=True)

            # ê³µí†µ íŒ”ë ˆíŠ¸ ì¶”ì¶œ + ë¬´ë“œ ì¡°ì •
            with st.spinner("ì—¬ëŸ¬ ì´ë¯¸ì§€ì—ì„œ ê³µí†µ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ ì¶”ì¶œ ì¤‘..."):
                base_colors = extract_palette_from_images(
                    pil_images, num_colors=num_palette_colors
                )
                adjusted_colors = adjust_colors_with_mood(
                    base_colors, brightness_level, saturation_level
                )
                palette_fig = plot_palette(adjusted_colors)

            st.subheader("â‘¡ ë¬´ë“œ íŒŒë¼ë¯¸í„° ë°˜ì˜ëœ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸")
            if palette_fig is not None:
                st.pyplot(palette_fig)
            else:
                st.write("íŒ”ë ˆíŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

        # --------------------
        # ì˜¤ë¥¸ìª½: ë¬´ë“œ ë¶„ì„ + ë°°ê²½í™”ë©´ ìƒì„±
        # --------------------
        with col_right:
            st.subheader("â‘¢ ë¬´ë“œ ë¶„ì„ & ë°°ê²½í™”ë©´ ìƒì„±")

            mood_param_text = describe_mood_params(
                brightness_level, saturation_level, abstract_level
            )
            st.markdown("**ë¬´ë“œ íŒŒë¼ë¯¸í„° ì„¤ëª…**")
            st.write(mood_param_text)

            # 1) AI ë¬´ë“œ ë¶„ì„ (ìˆìœ¼ë©´)
            analysis_text = ""
            if client is not None:
                image_contents = []
                for img in pil_images:
                    img_b64 = image_to_base64(img)
                    image_contents.append(
                        {
                            "type": "input_image",
                            "image_url": {"url": f"data:image/png;base64,{img_b64}"},
                        }
                    )

                user_text = (
                    "ë‹¤ìŒ ì—¬ëŸ¬ ì´ë¯¸ì§€ë“¤ì˜ ê³µí†µëœ ë¬´ë“œì™€ ìŠ¤íƒ€ì¼, ì»¬ëŸ¬ íŠ¹ì§•ì„ "
                    "íŒ¨ì…˜/í…ìŠ¤íƒ€ì¼ ê´€ì ì—ì„œ ìš”ì•½í•´ ì¤˜. "
                    "ìµœëŒ€ 5ì¤„ ì´ë‚´ë¡œ í‚¤ì›Œë“œ ìœ„ì£¼ë¡œ ì •ë¦¬í•´ ì¤˜."
                )
                user_text += (
                    f"\nì°¸ê³  ìŠ¤íƒ€ì¼ í‚¤ì›Œë“œ: {style_option}. "
                    f"\në¬´ë“œ íŒŒë¼ë¯¸í„°: {mood_param_text}"
                )
                if extra_prompt:
                    user_text += f"\nì¶”ê°€ í‚¤ì›Œë“œ: {extra_prompt}"

                with st.spinner("AIê°€ ë¬´ë“œ/ìŠ¤íƒ€ì¼ì„ ë¶„ì„í•˜ëŠ” ì¤‘..."):
                    try:
                        analysis_response = client.chat.completions.create(
                            model="gpt-4o-mini",
                            messages=[
                                {
                                    "role": "system",
                                    "content": (
                                        "You are an expert in fashion, "
                                        "textile design, and color theory. "
                                        "Analyze the shared mood, style, and color palette "
                                        "across the given reference images."
                                    ),
                                },
                                {
                                    "role": "user",
                                    "content": image_contents
                                    + [{"type": "text", "text": user_text}],
                                },
                            ],
                        )
                        analysis_text = (
                            analysis_response.choices[0].message.content.strip()
                        )
                        st.markdown("**AI ë¬´ë“œ & ìŠ¤íƒ€ì¼ ë¶„ì„ ê²°ê³¼**")
                        st.write(analysis_text)
                    except Exception as e:
                        st.error(f"ë¬´ë“œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
                        analysis_text = ""
            else:
                st.info("ì‚¬ì´ë“œë°”ì— OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ë©´, AI ë¬´ë“œ ë¶„ì„ ê²°ê³¼ë„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

            st.markdown("---")
            st.subheader("â‘£ ìƒì„±ëœ ë°°ê²½í™”ë©´")

            # 2) ì„ íƒí•œ ëª¨ë“œì— ë”°ë¼ ë°°ê²½í™”ë©´ ìƒì„±
            with st.spinner("ë°°ê²½í™”ë©´ì„ ìƒì„±í•˜ëŠ” ì¤‘..."):
                try:
                    wallpaper_img = None
                    wallpaper_bytes = None

                    # (1) ë‹¨ìƒ‰
                    if generation_mode.startswith("ë‹¨ìƒ‰"):
                        wallpaper_img = generate_solid_wallpaper(adjusted_colors)

                    # (2) íŒ¨í„´ë“¤
                    elif generation_mode.startswith("Stripe"):
                        wallpaper_img = generate_stripe_pattern(adjusted_colors)
                    elif generation_mode.startswith("Check"):
                        wallpaper_img = generate_check_pattern(adjusted_colors)
                    elif generation_mode.startswith("Dot"):
                        wallpaper_img = generate_dot_pattern(adjusted_colors)

                    # (3) AI ê¸°ë°˜ ì´ë¯¸ì§€ ìƒì„± (ë¹„ìŠ·í•œ ë¬´ë“œ / ì¶”ìƒ)
                    elif "ë¹„ìŠ·í•œ ë¬´ë“œì˜ ì´ë¯¸ì§€" in generation_mode or "ì¶”ìƒ ë°°ê²½í™”ë©´" in generation_mode:
                        if client is None:
                            st.error("AI ì´ë¯¸ì§€ ìƒì„±ì„ ìœ„í•´ OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
                        else:
                            palette_hex = colors_to_hex_list(adjusted_colors)
                            palette_text = ", ".join(palette_hex) if palette_hex else "neutral tones"

                            base_prompt = (
                                f"Create a phone wallpaper inspired by the following moodboard. "
                                f"Overall style: {style_option}. "
                                f"Main palette colors: {palette_text}. "
                                f"Mood parameters: {mood_param_text}. "
                                f"Abstractness description: {abstractness_phrase(abstract_level)}. "
                            )

                            if analysis_text:
                                base_prompt += f"\nMoodboard description: {analysis_text}\n"

                            if "ë¹„ìŠ·í•œ ë¬´ë“œì˜ ì´ë¯¸ì§€" in generation_mode:
                                base_prompt += (
                                    "The wallpaper should feel like a natural extension of the reference images, "
                                    "with similar atmosphere and mood. It can be soft and photographic or lightly stylized, "
                                    "but still usable as a background (not too busy, leave some empty space). "
                                )
                            elif "ì¶”ìƒ ë°°ê²½í™”ë©´" in generation_mode:
                                base_prompt += (
                                    "The wallpaper should be an abstract background that focuses on color, shapes and texture, "
                                    "without recognizable objects. It should work well as a phone wallpaper."
                                )

                            if extra_prompt:
                                base_prompt += f"\nAdditional style keywords: {extra_prompt}."

                            image_response = client.images.generate(
                                model="gpt-image-1",
                                prompt=base_prompt,
                                size="1024x1792",
                                n=1,
                            )
                            generated_b64 = image_response.data[0].b64_json
                            wallpaper_bytes = base64.b64decode(generated_b64)

                    # ê³µí†µ í‘œì‹œ/ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
                    if wallpaper_img is not None:
                        buf = io.BytesIO()
                        wallpaper_img.save(buf, format="PNG")
                        wallpaper_bytes = buf.getvalue()

                    if wallpaper_bytes is not None:
                        st.image(wallpaper_bytes, use_column_width=True)
                        st.download_button(
                            label="ğŸ“¥ ë°°ê²½í™”ë©´ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ",
                            data=wallpaper_bytes,
                            file_name="wallpaper.png",
                            mime="image/png",
                        )
                    else:
                        st.warning("ë°°ê²½í™”ë©´ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")

                except Exception as e:
                    st.error(f"ë°°ê²½í™”ë©´ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")